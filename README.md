# GoYin
ç¬¬å…­å±Šå­—èŠ‚è·³åŠ¨é’è®­è¥åç«¯æç®€ç‰ˆæŠ–éŸ³â€”â€”è·å¾—äºŒç­‰å¥–ğŸ¥ˆ

å®ç°äº†ç”¨æˆ·åŠŸèƒ½ï¼Œäº’åŠ¨åŠŸèƒ½ï¼Œç¤¾äº¤åŠŸèƒ½ï¼Œè§†é¢‘åŠŸèƒ½ï¼ŒèŠå¤©åŠŸèƒ½

## é¡¹ç›®ç‰¹ç‚¹

### æ˜“ç»´æŠ¤

Â· æ—¥å¿—å…¨è¦†ç›–ï¼Œé¢å¤–æ—¥å¿—ç»„ä»¶å®ç°æ—¥å¿—è¿‡æ»¤ï¼Œæ—¥å¿—å¯è§†åŒ–ï¼Œæ—¥å¿—åˆ†ç±»æå–æœ‰æ•ˆä¿¡æ¯

Â· å¯è§‚æµ‹ç»„ä»¶å®ç°é“¾è·¯è¿½è¸ªï¼Œæ•°æ®ç›‘æ§å¹¶å®ç°å¯è§†åŒ–

Â· é‡‡ç”¨å¾®æœåŠ¡æ¡†æ¶ï¼Œå¹¶å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°ç»“æ„è§£è€¦åŒ–

Â· ä½¿ç”¨é…ç½®ä¸­å¿ƒå¯¹é…ç½®æ–‡ä»¶è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå¯è¿›è¡Œç‰ˆæœ¬å›æº¯å’Œç›‘å¬æŸ¥è¯¢

### é«˜å¯ç”¨

Â· k8sé›†ç¾¤éƒ¨ç½²ï¼Œå®ç°é«˜å¯æ‹“å±•æ€§

Â· æ¶ˆæ¯é˜Ÿåˆ—å®ç°æµé‡å‰Šå³°ï¼Œå‡å°æµé‡å‹åŠ›

Â· å®ç°äº†é™æµï¼Œç†”æ–­

### é«˜æ€§èƒ½

Â· é‡‡ç”¨kitexå’Œhertzï¼Œé«˜æ€§èƒ½çš„å¾®æœåŠ¡æ¡†æ¶

Â· é€‚å½“ä½¿ç”¨å¹¶å‘å¤„ç†å‡å°‘è¯·æ±‚æ—¶é—´

Â· æ¶ˆæ¯é˜Ÿåˆ—å®ç°èŠå¤©æ¶ˆæ¯å¤„ç†

Â· å¯¹è±¡å­˜å‚¨æ•°æ®åº“å­˜å‚¨è§†é¢‘å’Œè§†é¢‘å°é¢ï¼ŒèŠ‚çœäº†æœåŠ¡å™¨èµ„æº

### å¯é æ€§

Â· æ•æ„Ÿä¿¡æ¯åŠ å¯†åŠ ç›å¤„ç†

Â· å…·å¤‡CIåŠŸèƒ½ï¼Œå¯¹æ•´ä½“é¡¹ç›®ä»£ç è¿›è¡Œäº†é«˜è¦†ç›–ç‡çš„å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•

Â· k8sé›†ç¾¤æ­å»ºé¡¹ç›®ï¼Œå…·å¤‡å®¹é”™æ€§ï¼Œæ”¯æŒæ¨ªå‘æ‹“å±•ä½¿é¡¹ç›®ç®¡ç†æ›´åŠ ä¾¿æ·ï¼Œè´Ÿè½½å‡è¡¡

## åŠŸèƒ½ä»‹ç»

**Â· åŸºç¡€æ¥å£ï¼š**

â€‹		Â· è§†é¢‘æµæ¥å£

â€‹		Â· ç”¨æˆ·æ³¨å†Œæ¥å£

â€‹		Â· ç”¨æˆ·ç™»å½•æ¥å£

â€‹		Â· ç”¨æˆ·ä¿¡æ¯

â€‹		Â· è§†é¢‘æŠ•ç¨¿

â€‹		Â· å‘å¸ƒåˆ—è¡¨

**Â· äº’åŠ¨æ¥å£ï¼š**

â€‹		Â· èµæ“ä½œ

â€‹		Â· å–œæ¬¢åˆ—è¡¨

â€‹		Â· è¯„è®ºæ“ä½œ

â€‹		Â· è§†é¢‘è¯„è®ºæ“ä½œ

**Â· ç¤¾äº¤æ¥å£ï¼š**

â€‹		Â· å…³ç³»æ“ä½œ

â€‹		Â· ç”¨æˆ·ä¸“æ³¨æ“ä½œ

â€‹		Â· ç”¨æˆ·ç²‰ä¸æ“ä½œ

â€‹		Â· ç”¨æˆ·å¥½å‹åˆ—è¡¨

â€‹		Â· æ¶ˆæ¯ï¼š

â€‹			Â· èŠå¤©è®°å½•

â€‹			Â· ç”¨æˆ·å¥½å‹åˆ—è¡¨

### ç›®å½•ç»“æ„
```
â”œâ”€â”€ deployment
â”‚   â”œâ”€â”€ GoYin-k8s
â”‚   â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”œâ”€â”€ chat
â”‚   â”‚   â”œâ”€â”€ ingress
â”‚   â”‚   â”‚   â””â”€â”€ common
â”‚   â”‚   â”‚       â””â”€â”€ rbac
â”‚   â”‚   â”œâ”€â”€ intetaction
â”‚   â”‚   â”œâ”€â”€ sociality
â”‚   â”‚   â”œâ”€â”€ user
â”‚   â”‚   â””â”€â”€ video
â”‚   â”œâ”€â”€ ip_info
â”‚   â””â”€â”€ opentelemetry
â”œâ”€â”€ docs
â”‚   â””â”€â”€ static
â”œâ”€â”€ server
â”‚   â”œâ”€â”€ common
â”‚   â”‚   â”œâ”€â”€ consts
â”‚   â”‚   â”œâ”€â”€ middleware
â”‚   â”‚   â”œâ”€â”€ test
â”‚   â”‚   â””â”€â”€ tools
â”‚   â”œâ”€â”€ idl
â”‚   â”œâ”€â”€ kitex_gen
â”‚   â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”‚   â””â”€â”€ apiservice
â”‚   â”‚   â”œâ”€â”€ base
â”‚   â”‚   â”œâ”€â”€ chat
â”‚   â”‚   â”‚   â””â”€â”€ chatservice
â”‚   â”‚   â”œâ”€â”€ errno
â”‚   â”‚   â”œâ”€â”€ interaction
â”‚   â”‚   â”‚   â””â”€â”€ interactionserver
â”‚   â”‚   â”œâ”€â”€ sociality
â”‚   â”‚   â”‚   â””â”€â”€ socialityservice
â”‚   â”‚   â”œâ”€â”€ user
â”‚   â”‚   â”‚   â””â”€â”€ userservice
â”‚   â”‚   â””â”€â”€ video
â”‚   â”‚       â””â”€â”€ videoservice
â”‚   â””â”€â”€ service
â”‚       â”œâ”€â”€ api
â”‚       â”‚   â”œâ”€â”€ biz
â”‚       â”‚   â”‚   â”œâ”€â”€ handler
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ api
â”‚       â”‚   â”‚   â”œâ”€â”€ model
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ api
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ base
â”‚       â”‚   â”‚   â””â”€â”€ router
â”‚       â”‚   â”‚       â””â”€â”€ api
â”‚       â”‚   â”œâ”€â”€ config
â”‚       â”‚   â”œâ”€â”€ initialize
â”‚       â”‚   â”‚   â””â”€â”€ rpc
â”‚       â”‚   â”œâ”€â”€ models
â”‚       â”‚   â”œâ”€â”€ pkg
â”‚       â”‚   â””â”€â”€ script
â”‚       â”œâ”€â”€ chat
â”‚       â”‚   â”œâ”€â”€ config
â”‚       â”‚   â”œâ”€â”€ dao
â”‚       â”‚   â”œâ”€â”€ initialize
â”‚       â”‚   â”œâ”€â”€ model
â”‚       â”‚   â”œâ”€â”€ pkg
â”‚       â”‚   â””â”€â”€ script
â”‚       â”œâ”€â”€ interaction
â”‚       â”‚   â”œâ”€â”€ config
â”‚       â”‚   â”œâ”€â”€ dao
â”‚       â”‚   â”œâ”€â”€ initialize
â”‚       â”‚   â”œâ”€â”€ model
â”‚       â”‚   â”œâ”€â”€ pkg
â”‚       â”‚   â””â”€â”€ script
â”‚       â”œâ”€â”€ sociality
â”‚       â”‚   â”œâ”€â”€ config
â”‚       â”‚   â”œâ”€â”€ dao
â”‚       â”‚   â”œâ”€â”€ initialize
â”‚       â”‚   â”œâ”€â”€ model
â”‚       â”‚   â”œâ”€â”€ pkg
â”‚       â”‚   â””â”€â”€ script
â”‚       â”œâ”€â”€ user
â”‚       â”‚   â”œâ”€â”€ config
â”‚       â”‚   â”œâ”€â”€ dao
â”‚       â”‚   â”œâ”€â”€ initialize
â”‚       â”‚   â”œâ”€â”€ model
â”‚       â”‚   â”œâ”€â”€ pkg
â”‚       â”‚   â””â”€â”€ script
â”‚       â””â”€â”€ video
â”‚           â”œâ”€â”€ config
â”‚           â”œâ”€â”€ dao
â”‚           â”œâ”€â”€ initialize
â”‚           â”œâ”€â”€ model
â”‚           â”œâ”€â”€ pkg
â”‚           â””â”€â”€ script
```
## ä»£ç æ¶æ„å›¾

â€‹		![](./docs/static/æ¶æ„å›¾1-2023-08-30-1216.png)

![QQ20230830-230759](./docs/static/QQ20230830-230759.png)

## æŠ€æœ¯æ ˆ

å¾®æœåŠ¡æ¡†æ¶ï¼šhertzï¼Œkitex

é…ç½®ä¸­å¿ƒï¼šnacos

æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼šnacos

æ¶ˆæ¯é˜Ÿåˆ—ï¼šnsq

æ•°æ®åº“ï¼šmysqlï¼Œredisï¼Œminio

å¯è§‚æµ‹æ€§ç»„ä»¶ï¼šjaegerï¼Œvictoria-metricsï¼Œgrafana

æ—¥å¿—ç»„ä»¶ï¼šlogstashï¼Œelasticsearchï¼Œkibana

äº‘åŸç”ŸæŠ€æœ¯æ ˆï¼šk8sï¼Œdockerï¼Œnginx-ingress

CI:github-action

## å…·ä½“åŠŸèƒ½

### æ•°æ®åº“

#### mysql

è¿ç”¨`gorm`æ¡†æ¶å®ç°æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ï¼š

![./docs/statistic/gorm.JPG](./docs/static/gorm.JPG)

- é€šè¿‡äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®åº“ä¸­çš„æ•°æ®å§‹ç»ˆä¿æŒä¸€è‡´å’Œå¯é ï¼Œé¿å…äº†æ•°æ®æŸåæˆ–ä¸å®Œæ•´çš„é£é™©ã€‚ 
- ä½¿ç”¨ç´¢å¼•å¸®åŠ©æ•°æ®åº“å¿«é€Ÿå®šä½åˆ°ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ•°æ®ï¼Œä»è€Œé¿å…äº†å…¨è¡¨æ‰«æçš„å¼€é”€ï¼Œæé«˜äº†æŸ¥è¯¢æ•ˆç‡ã€‚
- åˆ©ç”¨gormæœ¬èº«ç‰¹æ€§å¹¶é€šè¿‡ç®€å•é€»è¾‘åˆ¤æ–­ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†sqlæ³¨å…¥é£é™©ã€‚

![./docs/statistic/QQ20230830-220032.png](./docs/static/QQ20230830-220032.png)

![](./docs/static/QQ20230830-220107.png)



![QQ20230830-220132](./docs/static/QQ20230830-220132.png)

![QQ20230830-220141](./docs/static/QQ20230830-220141.png)

![QQ20230830-220157](./docs/static/QQ20230830-220157.png)

#### redis

![QQ20230830-223757](./docs/static/QQ20230830-223757.png)

![QQ20230830-223943](./docs/static/QQ20230830-223943.png)

#### minio

![QQ20230830-223911](./docs/static/QQ20230830-223911.png)

### nacos

![QQ20230830-223232](./docs/static/QQ20230830-223232.png)

### å¯è§‚æµ‹æ€§

![QQ20230830-224259](./docs/static/QQ20230830-224259.png)

![QQ20230830-224308](./docs/static/QQ20230830-224308.png)

![QQ20230831-104652](./docs/static/QQ20230831-104652.png)

### æ¶ˆæ¯é˜Ÿåˆ—

![QQ20230830-230924](./docs/static/QQ20230830-230924.png)

![QQ20230830-230933](./docs/static/QQ20230830-230933.png)

![QQ20230831-103730](./docs/static/QQ20230831-103730.png)

### pprof

å¯é€šè¿‡ä»¥ä¸‹ä»£ç æŸ¥çœ‹ï¼š

``` go tool pprof -http=:8001 http://127.0.0.1:8080/debug/pprof/profile ```

![pprof.png](./docs/static/pprof.png)

### Sentinel

- å‡ä»¥`nacos`ä½œä¸ºè§„åˆ™é…ç½®ä¸­å¿ƒ

#### apiæ¥å…¥é™æµç»„ä»¶

```go
func InitSentinel() {
	cfg := config.NewDefaultConfig()
	cfg.Sentinel.Log.Dir = "./tmp/sentinel/api"
	err := sentinel.InitWithConfig(cfg)
	if err != nil {
		hlog.Fatal("init sentinel failed", err)
	}
	_, err = flow.LoadRules([]*flow.Rule{
		{
			Resource:               serverConfig.GlobalServerConfig.FlowRule.Resource,
			Threshold:              float64(serverConfig.GlobalServerConfig.FlowRule.Threshold),
			TokenCalculateStrategy: flow.TokenCalculateStrategy(serverConfig.GlobalServerConfig.FlowRule.TokenCalculateStrategy),
			ControlBehavior:        flow.ControlBehavior(serverConfig.GlobalServerConfig.FlowRule.TokenCalculateStrategy),
			StatIntervalInMs:       serverConfig.GlobalServerConfig.FlowRule.StatIntervalInMs,
		},
	})
	if err != nil {
		hlog.Fatal("load sentinel failed", err)
	}
}
```

```go
func main(){
    ...
    h.Use(hertzSentinel.SentinelServerMiddleware(
   hertzSentinel.WithServerResourceExtractor(func(ctx context.Context, requestContext *app.RequestContext) string {
      return config.GlobalServerConfig.FlowRule.Resource
   }),
   // abort with status 429 by default
   hertzSentinel.WithServerBlockFallback(func(c context.Context, ctx *app.RequestContext) {
      ctx.JSON(http.StatusTooManyRequests, nil)
      ctx.Abort()
   }),
))
    ...
}
```

#### rpcä½¿ç”¨ç†”æ–­å™¨

- ä»¥useræœåŠ¡ä¸ºä¾‹

```go
func Sentinel() {
	conf := SentinelConfig.NewDefaultConfig()
	conf.Sentinel.Log.Dir = consts.UserSentinelFilePath
	err := sentinel.InitWithConfig(conf)
	if err != nil {
		klog.Fatal(err)
	}
	// æ³¨å†ŒçŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼Œç”¨äºè§‚å¯Ÿå†…éƒ¨æ–­è·¯å™¨çš„çŠ¶æ€å˜åŒ–
	circuitbreaker.RegisterStateChangeListeners(&stateChangeTestListener{})
	c := config.GlobalServerConfig.CbRule
	// åŠ è½½æ–­è·¯å™¨è§„åˆ™
	_, err = circuitbreaker.LoadRules([]*circuitbreaker.Rule{
		// ç»Ÿè®¡æ—¶é—´çª—å£=5ç§’ï¼Œæ¢å¤æ—¶é—´=3ç§’ï¼Œæ…¢è¯·æ±‚ä¸Šé™=50æ¯«ç§’ï¼Œæœ€å¤§æ…¢è¯·æ±‚æ¯”ä¾‹=50%
		{
			Resource:                     c.Resource,
			Strategy:                     circuitbreaker.Strategy(c.Strategy),
			RetryTimeoutMs:               c.RetryTimeoutMs,
			MinRequestAmount:             c.MinRequestAmount,
			StatIntervalMs:               c.StatIntervalMs,
			StatSlidingWindowBucketCount: c.StatSlidingWindowBucketCount,
			MaxAllowedRtMs:               c.MaxAllowedRtMs,
			Threshold:                    c.Threshold,
		},
	})
	if err != nil {
		klog.Fatal(err)
	}
}
```

```go
func main() {
	srv := user.NewServer(impl,
        ...                  
		// QPSé™æµ
		server.WithLimit(&limit.Option{MaxConnections: 2000, MaxQPS: 500}),
		// ç†”æ–­
		server.WithMiddleware(kitexSentinel.SentinelServerMiddleware(
			kitexSentinel.WithResourceExtract(func(ctx context.Context, req, resp interface{}) string {
				return config.GlobalServerConfig.CbRule.Resource
			}),
			kitexSentinel.WithBlockFallback(func(ctx context.Context, req, resp interface{}, blockErr error) error {
				return errors.New("service block")
			}),
		)),
	)
    ...
}
```



### æ—¥å¿—

#### Kibanaå®ç°æ—¥å¿—å¯è§†åŒ–

![kibana1](./docs/static/kibana1.png)

#### æŸ¥çœ‹æŒ‡å®šé”™è¯¯ç­‰çº§æ—¥å¿—

![kibana2](./docs/static/kibana2.png)

#### æ ¹æ®feedæµè¯·æ±‚ipç»Ÿè®¡ç”¨æˆ·æ¥æº

![kibana3](./docs/static/kibana3.png)

#### kibanaå›¾è¡¨é¢æ¿

- æ—¥å¿—é”™è¯¯ç›‘æµ‹
- feedæµæ¯æ—¥ä¸åŒæ—¶é—´æ®µçš„è¯·æ±‚æ¬¡æ•°
- feedæµè¯·æ±‚ç”¨æˆ·çš„åŸå¸‚top10

![dashboard1](./docs/static/dashboard1.png)

![dashboard2](./docs/static/dashboard2.png)

#### logstashé…ç½®æ–‡ä»¶å±•ç¤º

- æ ¹æ®ä¸åŒç±»å‹çš„æ—¥å¿—ä¿¡æ¯åˆ†åˆ«æ˜ å°„å­—æ®µ
- å®æ—¶æ”¶é›†æ—¥å¿—ä¿¡æ¯ï¼Œé‡å¯åä»å¤´è¯»å–

![logstash](./docs/static/logstash.png)

### k8s

#### æ­¥éª¤

##### åˆ›å»º master èŠ‚ç‚¹
è™šæ‹Ÿæœºå†…ç½‘æ­å»º k8s é›†ç¾¤

#### åˆ›å»º master èŠ‚ç‚¹

![QQ20230827-213037@2x](./docs/static/QQ20230827-213037@2x.png)

##### åˆ›å»º worker èŠ‚ç‚¹å¹¶è¿æ¥åˆ° master èŠ‚ç‚¹

![fa316762dd97c5956cc5e2895992959b](./docs/static/fa316762dd97c5956cc5e2895992959b.png)

##### åˆ›å»ºç¬¬ä¸€ä¸ª deployment å’Œ service

![51c1eb02abb88b4dd136c6a15f8463cf](./docs/static/51c1eb02abb88b4dd136c6a15f8463cf.png)

![QQ20230829-135029](./docs/static/QQ20230829-135029.png)

##### åˆ›å»ºå‰©ä¸‹çš„å‡ ä¸ªæœåŠ¡èŠ‚ç‚¹

![QQ20230829-183659@2x](./docs/static/QQ20230829-183659@2x.png)

service è½¬å‘httpè¯·æ±‚æˆåŠŸ

![QQ20230829-182301](./docs/static/QQ20230829-182301.png)

#### é…ç½® nginx-ingress

![QQ20230831-202319@2x](./docs/static/QQ20230831-202319@2x.png)

![QQ20230831-202347@2x](./docs/static/QQ20230831-202347@2x.png)

#### service+deploymentéƒ¨ç½²ä¼˜åŠ¿
1. æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼šService å¯ä»¥å°†å¤šä¸ª Pod ç»„åˆæˆä¸€ä¸ªé€»è¾‘çš„æœåŠ¡ï¼Œå¹¶ä¸ºè¿™ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„è™šæ‹Ÿ IP åœ°å€ã€‚è¿™æ ·ï¼Œæ— è®º Pod çš„æ•°é‡å¦‚ä½•å˜åŒ–ï¼ŒæœåŠ¡çš„è®¿é—®åœ°å€éƒ½ä¿æŒä¸å˜ï¼ŒåŒæ—¶è¿˜å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„ Pod ä¸Šã€‚
2. è‡ªåŠ¨ä¼¸ç¼©ï¼šDeployment å¯ä»¥æ ¹æ®æŒ‡å®šçš„è§„åˆ™è‡ªåŠ¨è°ƒæ•´ Pod çš„å‰¯æœ¬æ•°é‡ï¼Œä»¥åº”å¯¹æµé‡çš„å¢å‡ã€‚è¿™æ ·å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è‡ªåŠ¨æ‰©å±•æˆ–æ”¶ç¼©åº”ç”¨ç¨‹åºçš„å®¹é‡ã€‚
3. æ— ç¼å‡çº§å’Œå›æ»šï¼šDeployment å…è®¸æ— ç¼åœ°è¿›è¡Œç‰ˆæœ¬å‡çº§å’Œå›æ»šã€‚é€šè¿‡é€æ­¥æ›¿æ¢ Pod çš„æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿æœåŠ¡åœ¨å‡çº§è¿‡ç¨‹ä¸­ä¸ä¸­æ–­ï¼Œå¹¶ä¸”åœ¨é‡åˆ°é—®é¢˜æ—¶å¯ä»¥å¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚
4. æ•…éšœæ¢å¤å’Œè‡ªæ„ˆï¼šä½¿ç”¨Deployment éƒ¨ç½²çš„åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨Kubernetesçš„è‡ªæ„ˆç‰¹æ€§ã€‚å¦‚æœæŸä¸ª Pod å‘ç”Ÿæ•…éšœï¼ŒKubernetes ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ¥æ›¿ä»£ã€‚

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

å¯¹æ¶‰åŠ MySQL ä¸ Redis çš„æ•°æ®æ“ä½œè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œä¸ºäº†è®©æµ‹è¯•çš„æ•°æ®ä¸å½±å“ä¸šåŠ¡æ•°æ®åº“ï¼Œé€‰æ‹©åœ¨ Docker å®¹å™¨å†…è¿›è¡Œæµ‹è¯•ã€‚å…·ä½“è¿‡ç¨‹ä¸ºåœ¨ Docker ä¸­å¯åŠ¨ä¸€ä¸ª MySQL æˆ– Redis çš„å®¹å™¨ï¼Œç„¶ååœ¨å®¹å™¨ä¸­å¯¹æ•°æ®åº“è¿›è¡Œåˆå§‹åŒ–å¹¶è¿›è¡Œæµ‹è¯•ã€‚åœ¨æµ‹è¯•ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤æ‰å®¹å™¨ï¼Œé‡Šæ”¾å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ã€‚

```go
func RunMysqlInDocker(t *testing.T) (cleanUpFunc func(), db *gorm.DB, err error) {
	c, err := client.NewClientWithOpts(client.WithVersion(api.DefaultVersion))
    
	if err != nil {
		return func() {}, nil, err
	}

	ctx := context.Background()

	resp, err := c.ContainerCreate(ctx, &container.Config{
		// ...
		},
		Env: []string{ // ...},
	}, &container.HostConfig{
		PortBindings: nat.PortMap{
			// ...
		},
	}, nil, nil, "")

	if err != nil {
		return func() {}, nil, err
	}

	containerID := resp.ID

	cleanUpFunc = func() {
		err = c.ContainerRemove(ctx, containerID, types.ContainerRemoveOptions{
			Force: true,
		})
		if err != nil {
			t.Error("remove test docker failed", err)
		}
	}

	err = c.ContainerStart(ctx, containerID, types.ContainerStartOptions{})
	if err != nil {
		return cleanUpFunc, nil, err
	}

	inspRes, err := c.ContainerInspect(ctx, containerID)
	if err != nil {
		return cleanUpFunc, nil, err
	}

	hostPort := inspRes.NetworkSettings.Ports[consts.MySQLContainerPort][0]
	port, _ := strconv.Atoi(hostPort.HostPort)
	mysqlDSN := fmt.Sprintf(consts.MySqlDSN, consts.MySQLAdmin, consts.DockerTestMySQLPwd, hostPort.HostIP, port, consts.DockerTestMySQLDb)
	// Init mysql
	time.Sleep(20 * time.Second)
    
	db, err = gorm.Open(mysql.Open(mysqlDSN), &gorm.Config{
		// ...
		},
		// ...
			},
		),
	})

	// ...
}

```

é€»è¾‘ä¸ºé€šè¿‡è°ƒç”¨ Docker Api åœ¨ Docker ä¸­æ–°å»ºç«‹ä¸€ä¸ª MySQL çš„å®¹å™¨ï¼Œåœ¨æµ‹è¯•å®Œæ¯•åé€šè¿‡è¿”å›çš„ `cleanUpFunc` æ¥ è‡ªåŠ¨åˆ é™¤å®¹å™¨ã€‚

åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ä½¿ç”¨è¡¨æ ¼é©±åŠ¨æµ‹è¯•æµ‹è¯•å¤šç§æƒ…å†µã€‚

ä¸‹é¢ä»¥æµ‹è¯• user çš„ MySQL æ“ä½œä¸ºä¾‹ã€‚

```go
func TestUserLifecycleInMySQL(t *testing.T) {
	cleanUpFunc, db, err := test.RunMysqlInDocker(t)

	defer cleanUpFunc()

	if err != nil {
		t.Fatal(err)
	}

	dao := NewUser(db)

	ctx := context.Background()
    
    // ...

	cases := []struct {
		name       string
		op         func() (string, error)
		wantErr    bool
		wantResult string
	}{
        // ...
	}

	for _, cc := range cases {
		result, err := cc.op()
		if cc.wantErr {
			if err == nil {
				t.Errorf("%s:want error;got none", cc.name)
			} else {
				continue
			}
		}
		if err != nil {
			t.Errorf("%s:operation failed: %v", cc.name, err)
		}
		if result != cc.wantResult {
			t.Errorf("%s:result err: want %s,got %s", cc.name, cc.wantResult, result)
		}
	}
}
```
### æ€§èƒ½æµ‹è¯•

å¯¹ç¨‹åºè¿›è¡Œäº†å®Œå¤‡çš„æ€§èƒ½æµ‹è¯•ï¼Œå¹¶ä¸”æ ¹æ®æµ‹è¯•ç»“æœå¯¹ä»£ç è¿›è¡Œäº†ä¸€å®šç¨‹åº¦çš„ä¼˜åŒ–

å¯é€šè¿‡è¿è¡Œä»¥ä¸‹ä»£ç æŸ¥çœ‹ï¼š

``` go test -bench='.' -benchmem ```

![bench1.png](./docs/static/bench1.png)

ä¼˜åŒ–åï¼š

![bench2.png](./docs/static/bench2.png)

## é¡¹ç›®æ€»ç»“ä¸åæ€
1ï¼Œå·²å­˜åœ¨çš„é—®é¢˜ï¼š

(i)å•æµ‹è¦†ç›–ç‡è¿˜ä¸å¤Ÿé«˜

(ii)ä¸Šä¼ è§†é¢‘æ¥å£ä¸å¤Ÿä¼˜é›…

(iii)è¾¹ç•Œå¤„ç†è¿˜å¯ä»¥ä¼˜åŒ–

2ï¼Œå·²è¯†åˆ«å‡ºçš„ä¼˜åŒ–é¡¹ï¼š

(i)æ•°æ®åº“çš„ç¼“å­˜å¤„ç†ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬è¿™ä¸ªç®€æ˜“æŠ–éŸ³é‡Œï¼Œå¢ï¼ŒæŸ¥ä¸¤ç§æ“ä½œæ¯”è¾ƒå¤šã€‚å¦å¤–ä¸¤ç§å‡ ä¹æ²¡æœ‰æ¶‰åŠåˆ°ã€‚

æ‰€ä»¥æˆ‘çš„ç¼“å­˜ç­–ç•¥é‡‡ç”¨çš„æ˜¯ç®€åŒ–ç‰ˆçš„æ—è·¯ç¼“å­˜ï¼Œèƒ½å¤Ÿä¿è¯ç¼“å­˜çš„é«˜å‘½ä¸­æ€§ã€‚åŒæ—¶è®¾ç½®äº†mysqlå‘ç”Ÿé”™è¯¯æ—¶å›æ»šï¼Œä¿è¯äº†æ•°æ®ä¸€è‡´æ€§

(ii)mysqlæ•°æ®åº“è®¾ç½®äº†åˆç†çš„ç´¢å¼•ï¼Œèƒ½å¤Ÿæé«˜æŸ¥è¯¢æ•ˆç‡

(iii)è®¾ç½®äº†æ¶ˆæ¯é˜Ÿåˆ—å¯¹é«˜å¹¶å‘çš„è¯·æ±‚è¿›è¡Œå‰Šå³°å¤„ç†

3ï¼Œæ¶æ„æ¼”è¿›çš„å¯èƒ½æ€§

(i)ç»§ç»­ç»†åˆ†å¾®æœåŠ¡æ¶æ„ï¼Œè¿›ä¸€æ­¥è§£è€¦

(ii)å®ç°æ•æ„Ÿè¯å±è”½åŠŸèƒ½

(iii)k8så®ç°èµ„æºåˆ†éš”ç®¡ç†ï¼Œåº”ç”¨å‡çº§é™çº§

(iiii)å› ä¸ºå‰ç«¯æ˜¯å†™æ­»çš„é”™è¯¯ç åªæœ‰0å’Œé0çš„åŒºåˆ«ï¼Œæ‰€ä»¥å°±æ²¡åšå…¨å±€é”™è¯¯ç ï¼Œæœ‰æ—¶é—´å¯ä»¥åŠ ä¸Š

(iiiii)åœ¨æ€§èƒ½èµ„æºè¶³å¤Ÿçš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å¹¶å‘åœ°å¤„ç†æŸ¥è¯¢å¤šä¸ªrpcèŠ‚ç‚¹ï¼Œè¾¾åˆ°èŠ‚çº¦æ—¶é—´çš„æ•ˆæœ

4ï¼Œé¡¹ç›®è¿‡ç¨‹ä¸­çš„åæ€ä¸æ€»ç»“

(i)äº‹å…ˆåˆ—å¥½æ•´ä½“é¡¹ç›®æ¶æ„ï¼Œèƒ½å¤Ÿåœ¨å¼€å‘çš„æ—¶å€™å˜å¾—äº‹åŠåŠŸå€

(ii)æ—¥å¿—æ˜¯ä¸ªæ–¹ä¾¿debugçš„å¥½ä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§å‹é¡¹ç›®è€Œè¨€

(iii)è¿ç»´æ—¶ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¥½é…ç½®ä¾‹å¦‚systemctlæˆ–è€…k8sçš„serviceï¼Œæ–¹ä¾¿è¿›è¡Œå‘ç”ŸæŠ¥é”™ä¸­æ–­ä¹‹åæœåŠ¡é‡å¯

## é¸£è°¢
@[withoutabc](https://github.com/withoutabc)
@[KeiichiKasai](https://github.com/KeiichiKasai)
@[shiningstoned](https://github.com/shiningstoned)
@[Hanser001](https://github.com/Hanser001)

- [å­—èŠ‚è·³åŠ¨é’è®­è¥](https://youthcamp.bytedance.com/)
